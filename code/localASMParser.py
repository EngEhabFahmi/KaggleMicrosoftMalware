#!/usr/bin/env python
# -*- coding: utf-8 -*-

import re 
from collections import Counter 
import string 

def parseFile(fileName, prefixes=True):
    cnt = Counter()
    sectionsSeen = {}
    numSubroutines = 0
    with open(fileName) as f:
        for line in f:

            if ".data:00" in line:
                startTrigger = "_data"
                if prefixes:
                    prefix = "DT_"
                else:
                    prefix = ""
                if "_data" not in sectionsSeen:
                    triggered = False

            elif ".rdata:00" in line:
                startTrigger = "_rdata"
                if prefixes:
                    prefix = "RDT_"
                else:
                    prefix = ""

                if "_rdata" not in sectionsSeen:
                    triggered = False

            elif ".idata:00" in line:
                if prefixes:
                    prefix = "IDT_"
                else:
                    prefix = ""
                startTrigger = "_idata"
                if "_idata" not in sectionsSeen:
                    triggered = False
            else:
                startTrigger = "_text"
                prefix = ""
                if "_text" not in sectionsSeen:
                    triggered = False

            if startTrigger in line:
                triggered = True
                if startTrigger not in sectionsSeen:
                    sectionsSeen[startTrigger] = 0

            if triggered:
                sectionsSeen[startTrigger] += 1
                if "S U B R O U T I N E" in line:
                    numSubroutines += 1
                    continue
                else:
                    lineSplit = line.split('       ')
                    if len(lineSplit) > 1:
                        assembCode = lineSplit[1]
                    else:
                        assembCode = lineSplit[0]
                    tokens = assembCode.split()
                    for token in tokens:
                        if hasNoStopwords(token):
                            token = re.sub(r'[,;]','',token)
                            if 'rdata' in token:
                                cnt['rdata'] += 1
                            elif 'loc' in token:
                                cnt['loc'] += 1
                            else:
                                cnt[prefix + token] += 1

    return cnt, sectionsSeen, numSubroutines

def hasNoStopwords(token):
    stopwords = [".text:", '_text', 'Ãƒ', 'idata:', '_idata', 'rdata:', '_rdata', 'data:', '_data']
    for stopword in stopwords:
        if stopword in token:
            return False
    return True

if __name__ == "__main__":
    c, s, n = parseFile('dataSample/0A32eTdBKayjCWhZqDOQ.asm', False)
    print c
    # print s
    # print n