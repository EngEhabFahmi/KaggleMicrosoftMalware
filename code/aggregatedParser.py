#!/usr/bin/env python
# -*- coding: utf-8 -*-

from pyspark import SparkContext
import pandas as pd
from asm_parser import fileID, parseFile, asmReduce

if __name__ == "__main__":
    sc = SparkContext("spark://ec2-52-10-133-145.us-west-2.compute.amazonaws.com:7077", "ASM Parse Test")
    asmFiles = sc.wholeTextFiles("/Users/codywild/Desktop/MSAN/Module3/AdvancedML/KaggleMicrosoftMalware/dataSample/*.asm")
    trainLabels = pd.read_csv("/Users/codywild/Desktop/MSAN/Module3/AdvancedML/KaggleMicrosoftMalware/trainLabels.csv")
    trainDict = trainLabels.set_index('Id').to_dict()['Class']
    labelsBC = sc.broadcast(trainDict)
    asmMap = asmFiles.map(lambda x: (labelsBC.value[fileID(x[0])], parseFile(x[1].encode('utf-8'))))
    asmReduced = asmMap.reduceByKey(asmReduce)
    asmReduced.saveAsPickleFile('asmClassAgg', 1)
